#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define TAMANHO 9
#define NUM_BOMBAS 10
#define VAZIO 0
#define BOMBA -1
#define JOGANDO 0
#define PERDEU 1
#define GANHOU 2

int tela[TAMANHO][TAMANHO];
int tela_jogador[TAMANHO][TAMANHO];
int estado_jogo = JOGANDO;

int eValido(int l, int c) {
    return (l >= 0 && l < TAMANHO && c >= 0 && c < TAMANHO);}

int contaBombasVizinhos(int i, int j) {
    int cont = 0;
    for (int di = -1; di <= 1; di++)
        for (int dj = -1; dj <= 1; dj++)
            if ((di || dj) && eValido(i + di, j + dj) && tela[i + di][j + dj] == BOMBA)
                cont++;
    return cont;}

void inicializaTela() {
    for (int i = 0; i < TAMANHO; i++)
        for (int j = 0; j < TAMANHO; j++)
            tela[i][j] = VAZIO;

    srand(time(NULL));
    int bombas = 0;
    while (bombas < NUM_BOMBAS) {
        int l = rand() % TAMANHO;
        int c = rand() % TAMANHO;
        if (tela[l][c] != BOMBA) {
            tela[l][c] = BOMBA;
            bombas++;}}

    for (int i = 0; i < TAMANHO; i++)
        for (int j = 0; j < TAMANHO; j++)
            if (tela[i][j] != BOMBA)
                tela[i][j] = contaBombasVizinhos(i, j);}

void inicializaTelaJogador() {
    for (int i = 0; i < TAMANHO; i++)
        for (int j = 0; j < TAMANHO; j++)
            tela_jogador[i][j] = 0;}

void imprime(int revelarTudo) {
    printf("\n    ");
    for (int c = 0; c < TAMANHO; c++) printf("%d ", c);
    printf("\n  ");
    for (int k = 0; k < TAMANHO * 2 + 3; k++) printf("-");
    printf("\n");

    for (int i = 0; i < TAMANHO; i++) {
        printf("%d | ", i);
        for (int j = 0; j < TAMANHO; j++) {
            if (!revelarTudo && tela_jogador[i][j] == 0) {
                printf("X ");
                continue;}

            if (tela[i][j] == BOMBA)
                printf("@ ");
            else
                printf("%d ", tela[i][j]);
        }
        printf("\n");}
    printf("--------------------------------\n");}

void imprimeTelaJogador() { imprime(0); }
void imprimeTelaOriginal() { imprime(1); }

void revelaVazios(int l, int c) {
    if (!eValido(l, c) || tela_jogador[l][c] == 1) return;

    tela_jogador[l][c] = 1;

    if (tela[l][c] == VAZIO) {
        for (int di = -1; di <= 1; di++)
            for (int dj = -1; dj <= 1; dj++)
                if (di || dj) revelaVazios(l + di, c + dj);}}

void posicaoEscolhida(int l, int c) {
    if (!eValido(l, c)) {
        printf("Posição inválida.\n");
        return;}

    if (tela_jogador[l][c] == 1) {
        printf("Já revelado.\n");
        return;}

    if (tela[l][c] == BOMBA) {
        estado_jogo = PERDEU;
        printf("BOOM! Você perdeu.\n");
        imprimeTelaOriginal();
        return;}

    tela_jogador[l][c] = 1;

    if (tela[l][c] == VAZIO)
        revelaVazios(l, c);}

int verificaVitoria() {
    int reveladas = 0;
    int totalSeguras = TAMANHO * TAMANHO - NUM_BOMBAS;

    for (int i = 0; i < TAMANHO; i++)
        for (int j = 0; j < TAMANHO; j++)
            if (tela[i][j] != BOMBA && tela_jogador[i][j] == 1)
                reveladas++;

    if (reveladas == totalSeguras) {
        estado_jogo = GANHOU;
        return 1;}
    return 0;
}

int main() {
    int l, c;

    inicializaTela();
    inicializaTelaJogador();

    printf("\n");
    printf("* Bem-vindo ao Campo Minado!  *\n");
    printf("\n");

    while (estado_jogo == JOGANDO) {
        imprimeTelaJogador();

        printf("Escolha posição (linha coluna): ");
        if (scanf("%d %d", &l, &c) != 2) {
            printf("Entrada inválida.\n");
            while (getchar() != '\n');
            continue;}

        posicaoEscolhida(l, c);

        if (estado_jogo == JOGANDO)
            verificaVitoria();}

    if (estado_jogo == GANHOU) {
        imprimeTelaJogador();
        printf("Parabéns, você ganhou!\n");}

    printf("Fim de jogo.\n");

return 0; }
